{% extends "mandate/base.html" %}

{% load extras %}
{% load static %}
{% load humanize %}

{% block stylesheet %}<link rel="stylesheet" href="{% static 'mandate/mandate_details.css' %}">{% endblock %}

{% block content %}

	<div class="card text-center">
		<div class="card-body">
	  		You can take a printout of the pre-filled mandate form
			<a href="print">here</a>.
		</div>
  	</div>
	
	<div class="status-container" id="status-container">
		{% if mandate.mandate_image %}
		
		<p>Image uploaded and mandate submitted successfully.</p>
		
		{% else %}
		
		<p>Mandate image is not uploaded, upload it here:</p>
		
		<form action = "/mandates/mandate/{{mandate.id}}/" method="post" enctype="multipart/form-data">
			{% csrf_token %}
			{{form}}
			
			<div id="preview-container" class="preview-container"></div>
			
			<div id="formButtons" class="form-buttons">
				<button id="resetBtn" type="button" class="btn btn-outline-dark btn-sm" onClick="form.reset()">Reset</button>

				<div id="rotateBtn" class="btn-group" role="group" aria-label="Basic example">
					<button id="rotateLeft" type="button" class="btn btn-warning btn-sm">
						<div class="icon-container"><img src="/media/mandate/static/assets/images/arrow-counterclockwise.svg"></div>
					</button>

					<button id="fitWidth" type="button" class="btn btn-warning btn-sm">
						<div class="icon-container"><img src="/media/mandate/static/assets/images/arrows.svg"></div>
					</button>
					
					<button id="fitCanvas" type="button" class="btn btn-warning btn-sm">
						<div class="icon-container"><img src="/media/mandate/static/assets/images/arrows-angle-contract.svg"></div>
					</button>
					
					<button id="rotateRight" type="button" class="btn btn-warning btn-sm">
						<div class="icon-container"><img src="/media/mandate/static/assets/images/arrow-clockwise.svg"></div>
					</button>
				</div>

				<button id="cropBtn" type="button" class="btn btn-danger btn-sm">Crop</button>
				<button id="originalBtn" type="button" class="btn btn-info btn-sm">Use Original</button>
				<button id="submitBtn" type="button" class="btn btn-primary btn-sm">Submit Image</button>
			</div>
		</form>
		{% endif %}
	</div>

	<div class="mandate-details">
		<div>
	
			<div class="key">{{mandate|verbose_name:'umrn'}}</div>
			<div class="value">{{mandate.umrn}}UMRN WILL COME HERE</div>
	
			<div class="key">{{mandate|verbose_name:'message_reference'}}</div>
			<div class="value">{{mandate.message_reference}}</div>
	
			<div class="key">{{mandate|verbose_name:'currency'}}</div>
			<div class="value">{{mandate.currency}}</div>
	
			<div class="key">{{mandate|verbose_name:'fixed_or_max'}}</div>
			<div class="value">{{mandate.get_fixed_or_max_display}}</div>
	
			<div class="key">{{mandate|verbose_name:'amount'}}</div>
			<div class="value">{{mandate.amount|intcomma}}</div>
	
			<div class="key">{{mandate|verbose_name:'category'}}</div>
			<div class="value">{{mandate.category}}</div>
	
			<div class="key">{{mandate|verbose_name:'variant'}}</div>
			<div class="value">{{mandate.variant}}</div>
	
			<div class="key">{{mandate|verbose_name:'frequency'}}</div>
			<div class="value">{{mandate.frequency}}</div>
	
			<div class="key">{{mandate|verbose_name:'date_of_mandate'}}</div>
			<div class="value">{{mandate.date_of_mandate}}</div>
	
		</div>


		<div>

			<div class="key">{{mandate|verbose_name:'start_date'}}</div>
			<div class="value">{{mandate.start_date}}</div>
	
			<div class="key">{{mandate|verbose_name:'end_date'}}</div>
			<div class="value">{{mandate.end_date}}</div>
	
			<div class="key">{{mandate|verbose_name:'name_of_debtor_account_holder'}}</div>
			<div class="value">{{mandate.name_of_debtor_account_holder}}</div>
	
			<div class="key">{{mandate|verbose_name:'debtor_bank'}}</div>
			<div class="value">{{mandate.debtor_bank}}</div>
	
			<div class="key">{{mandate|verbose_name:'debtor_acc_type'}}</div>
			<div class="value">{{mandate.debtor_acc_type}}</div>
	
			<div class="key">{{mandate|verbose_name:'debtor_legal_account_number'}}</div>
			<div class="value">{{mandate.debtor_legal_account_number}}</div>
	
			<div class="key">{{mandate|verbose_name:'creditor_name'}}</div>
			<div class="value">{{mandate.creditor_name}}</div>
	
			<div class="key">{{mandate|verbose_name:'creditor_bank'}}</div>
			<div class="value">{{mandate.creditor_bank}}</div>
	
			<div class="key">{{mandate|verbose_name:'creditor_utility_code'}}</div>
			<div class="value">{{mandate.creditor_utility_code}}</div>
	
			<div class="key">{{mandate|verbose_name:'credit_account'}}</div>
			<div class="value">{{mandate.credit_account}}</div>
		</div>
	</div>


	{% if mandate.mandate_image %}
	<div class="mandate-image-container">
		<img class="img" src="/media/{{mandate.mandate_image}}">
	</div>

	{% else %}

	<script>
		let container = document.getElementById('preview-container');
		let input = document.getElementById('id_mandate_image');
		let form = input.form;
		let img = document.createElement('img');
		img.setAttribute('id', 'previewImg');
		img.style.cssText = ("width:100%;object-fit:contain;object-position: 50% 50%");
		let cropper = null;
		let canvas = null;
		
		function changePreview(event) {
			img.src = URL.createObjectURL(input.files[0]);

			if (cropper) {
				if (cropper.ready) {
					cropper.destroy();
				}
			}
			if (document.getElementById('previewImg')) {
				document.getElementById('previewImg').remove();
			}

			if (canvas) {
				if (canvas.parentElement) {canvas.remove();}
			}
			submitBtn.style.display = 'none';
			
			container.append(img);
			cropper = new Cropper(img, {viewMode: 2, responsive: false, dragMode: 'move', cropBoxMovable: false, toggleDragModeOnDblclick: false});

			container.style.display = 'block';
			resetBtn.style.display = 'inline-block';
			rotateBtn.style.display = 'inline-flex';
			cropBtn.style.display = 'inline-block';
			originalBtn.style.display = 'inline-block';

			input.parentElement.style.display = 'none';
		}

		function formReset() {
			if (cropper) {
				if (cropper.ready) {
					cropper.destroy();
				}
			}
			if (document.getElementById('previewImg')) {
				document.getElementById('previewImg').remove();
			}
			if (canvas) {
				if (canvas.parentElement) {canvas.remove();}
			}
			
			resetBtn.style.display = 'none';
			rotateBtn.style.display = 'none';
			cropBtn.style.display = 'none';
			originalBtn.style.display = 'none';
			submitBtn.style.display = 'none';
			container.style.display = 'none';
			input.parentElement.style.display = '';
		}

		cropBtn.onclick = function() {
			canvas = cropper.getCroppedCanvas();
			canvas.style.cssText = "width:100%;object-fit:contain;object-position: 50% 50%";
			cropper.destroy();
			img.remove();
			container.style.display = 'none';
			formButtons.before(canvas);
			rotateBtn.style.display = 'none';
			cropBtn.style.display = 'none';
			originalBtn.style.display = 'none';
			submitBtn.style.display = 'inline-block';
		}

		originalBtn.onclick = function() {
			cropper.destroy();
			formButtons.before(img);
			container.style.display = 'none';
			rotateBtn.style.display = 'none';
			cropBtn.style.display = 'none';
			originalBtn.style.display = 'none';
			submitBtn.style.display = 'inline-block';
		}

		function centerCanvas(cropper, ratio) {
			cropper.clear();
			ctnrData = cropper.getContainerData();
			cnvsData = cropper.getCanvasData();
			if (cnvsData.height > ctnrData.height) {
				cropper.setCanvasData({height: ctnrData.height});
				cropper.setCanvasData({left: ctnrData.width/2 - cropper.getCanvasData().width/2});
			}
			else {
				cropper.setCanvasData({width: ctnrData.width});
				cropper.setCanvasData({top: ctnrData.height/2 - cropper.getCanvasData().height/2});
			}

			c = cropper.getCanvasData();
			obj = {
				left: c.left + c.width * (1 - ratio)/2,
				top: c.top + c.height * (1 - ratio)/2,
				width: c.width * ratio,
				height: c.height * ratio
			}

			cropper.crop();
			cropper.setCropBoxData(obj);
		}

		rotateLeft.onclick = function() {
			cropper.rotate(-90);
			centerCanvas(cropper, 0.8);
		}

		rotateRight.onclick = function() {
			cropper.rotate(90);
			centerCanvas(cropper, 0.8);
		}

		fitWidth.onclick = function() {
			cropper.setCanvasData({
				width: cropper.getContainerData().width,
				left: 0,
				top: cropper.getCropBoxData().top
			});
		}

		fitCanvas.onclick = function() {
			centerCanvas(cropper, 0.8);
		}

		submitBtn.onclick = async function() {
			let formData = new FormData(form);

			if (img.parentElement == container) {
				// original image will be uploaded
				let response = await fetch('/mandates/mandate/{{mandate.id}}/', {
					method: 'POST',
					body: formData
				});

				let result = await response.text();
				console.log(result);
			}

			else if (canvas.parentElement == container) {
				//cropped image will be uploaded
				//first create image/png blob from canvas
				//and add it in form data in the callback function
				canvas.toBlob(async function(blob) {
					formData.set("mandate_image", blob, "{{ mandate.id|stringformat:'06d' }}_cropped.png");

					let response = await fetch('/mandates/mandate/{{mandate.id}}/', {
						method: 'POST',
						body: formData
					});

					let result = await response.text();
					console.log(result);
				}, 'image/png');
			}

			else {
				alert('Some error has occured, please reload the page and try again.');
			}
		}

		input.addEventListener('change', changePreview);
		form.addEventListener('reset', formReset);
		
	</script>

	{% endif %}
{% endblock %}